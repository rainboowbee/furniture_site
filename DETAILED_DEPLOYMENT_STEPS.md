# Детальная инструкция по выполнению автоматического скрипта

## 📋 Обзор второго этапа

Второй этап "Выполнение автоматического скрипта" состоит из 10 подэтапов, которые необходимо выполнить последовательно для успешного развертывания приложения.

---

## 🔽 2.1 Скачивание скрипта развертывания

### Что происходит:
Скачиваем автоматический скрипт `deploy.sh`, который выполнит всю работу по развертыванию.

### Пошаговые действия:

#### Шаг 1: Переход в домашнюю директорию
```bash
cd ~
pwd
# Должно показать: /home/ваш_пользователь
```

#### Шаг 2: Скачивание скрипта
```bash
curl -O https://raw.githubusercontent.com/ваш_username/gardenfab/main/deploy.sh
```

**Объяснение команды:**
- `curl` - утилита для скачивания файлов
- `-O` - сохранить файл с оригинальным именем
- URL указывает на raw содержимое файла в GitHub

#### Шаг 3: Проверка скачивания
```bash
ls -la deploy.sh
```

**Ожидаемый результат:**
```
-rw-r--r-- 1 user user 1234 Aug 15 10:30 deploy.sh
```

### Альтернативные способы получения скрипта:

#### Вариант A: Через Git (рекомендуется)
```bash
# Клонируем весь проект
git clone https://github.com/ваш_username/gardenfab.git
cd gardenfab

# Копируем скрипт в домашнюю директорию
cp deploy.sh ~/
cd ~
```

#### Вариант B: Через SCP
```bash
# На локальном компьютере (в отдельном терминале):
scp deploy.sh user@ваш_сервер_ip:~/

# На сервере проверяем:
ls -la ~/deploy.sh
```

#### Вариант C: Создание вручную
```bash
nano deploy.sh
# Вставляем содержимое скрипта
# Ctrl+X, Y, Enter для сохранения
```

---

## 🔍 2.2 Проверка содержимого скрипта

### Что происходит:
Проверяем, что скачанный файл действительно является bash скриптом и содержит корректный код.

### Пошаговые действия:

#### Шаг 1: Просмотр начала файла
```bash
head -20 deploy.sh
```

**Ожидаемый результат:**
```bash
#!/bin/bash

# Скрипт автоматического развертывания GardenFab
# Использование: ./deploy.sh [production|staging]
...
```

#### Шаг 2: Проверка типа файла
```bash
file deploy.sh
```

**Ожидаемый результат:**
```
deploy.sh: Bourne-Again shell script, ASCII text executable
```

#### Шаг 3: Проверка прав доступа
```bash
ls -la deploy.sh
```

**Ожидаемый результат:**
```
-rw-r--r-- 1 user user 1234 Aug 15 10:30 deploy.sh
```

---

## 🔐 2.3 Настройка прав доступа

### Что происходит:
Делаем скрипт исполняемым, чтобы система могла его запустить.

### Пошаговые действия:

#### Шаг 1: Установка права на выполнение
```bash
chmod +x deploy.sh
```

**Объяснение команды:**
- `chmod` - изменение прав доступа к файлу
- `+x` - добавить право на выполнение для всех пользователей

#### Шаг 2: Проверка прав
```bash
ls -la deploy.sh
```

**Ожидаемый результат:**
```
-rwxr-xr-x 1 user user 1234 Aug 15 10:30 deploy.sh
```
**Объяснение:**
- `-rwxr-xr-x` - права доступа
- `rwx` - владелец может читать, писать и выполнять
- `r-x` - группа может читать и выполнять
- `r-x` - остальные могут читать и выполнять

---

## 🔧 2.4 Предварительная проверка системы

### Что происходит:
Проверяем наличие всех необходимых пакетов и компонентов для работы скрипта.

### Пошаговые действия:

#### Шаг 1: Проверка наличия основных пакетов
```bash
which node
which npm
which git
which nginx
```

**Ожидаемый результат:**
```
/usr/bin/node
/usr/bin/npm
/usr/bin/git
/usr/sbin/nginx
```

**Если команда `which` ничего не возвращает:**
```bash
# Устанавливаем недостающие пакеты
sudo apt update
sudo apt install -y nodejs npm git nginx postgresql postgresql-contrib
```

#### Шаг 2: Проверка версий
```bash
node --version
npm --version
```

**Ожидаемый результат:**
```
v18.17.0
9.6.7
```

**Минимальные требования:**
- Node.js: 18.x или выше
- npm: 9.x или выше

---

## 📁 2.5 Создание необходимых директорий

### Что происходит:
Создаем структуру директорий для размещения приложения, логов и резервных копий.

### Пошаговые действия:

#### Шаг 1: Создание основных директорий
```bash
sudo mkdir -p /var/www/gardenfab
sudo mkdir -p /var/backups/gardenfab
sudo mkdir -p /var/log/gardenfab
sudo mkdir -p /var/log/pm2
```

**Объяснение директорий:**
- `/var/www/gardenfab` - файлы приложения
- `/var/backups/gardenfab` - резервные копии
- `/var/log/gardenfab` - логи приложения
- `/var/log/pm2` - логи менеджера процессов

#### Шаг 2: Создание пользователя
```bash
sudo adduser --disabled-password --gecos "" gardenfab || echo "Пользователь уже существует"
```

**Объяснение команды:**
- `--disabled-password` - пользователь без пароля (только для системных операций)
- `--gecos ""` - пустая информация о пользователе
- `|| echo "..."` - если пользователь уже существует, выводим сообщение

#### Шаг 3: Установка прав доступа
```bash
sudo chown -R gardenfab:gardenfab /var/www/gardenfab
sudo chown -R gardenfab:gardenfab /var/backups/gardenfab
sudo chown -R gardenfab:gardenfab /var/log/gardenfab
sudo chown -R gardenfab:gardenfab /var/log/pm2
```

**Проверка прав:**
```bash
ls -la /var/www/ | grep gardenfab
ls -la /var/backups/ | grep gardenfab
ls -la /var/log/ | grep gardenfab
```

---

## 🗄️ 2.6 Настройка базы данных

### Что происходит:
Создаем базу данных PostgreSQL и пользователя для приложения.

### Пошаговые действия:

#### Шаг 1: Переход в PostgreSQL консоль
```bash
sudo -u postgres psql
```

**Объяснение:**
- `sudo -u postgres` - выполнить команду от имени пользователя postgres
- `psql` - запуск PostgreSQL клиента

#### Шаг 2: Создание базы данных
```sql
CREATE DATABASE gardenfab;
```

**Проверка:**
```sql
\l
-- Должна появиться строка с gardenfab
```

#### Шаг 3: Создание пользователя
```sql
CREATE USER gardenfab_user WITH ENCRYPTED PASSWORD 'ваш_надежный_пароль';
```

**Требования к паролю:**
- Минимум 8 символов
- Содержать буквы, цифры и специальные символы
- Не использовать простые слова

#### Шаг 4: Назначение прав
```sql
GRANT ALL PRIVILEGES ON DATABASE gardenfab TO gardenfab_user;
ALTER USER gardenfab_user CREATEDB;
```

**Объяснение прав:**
- `ALL PRIVILEGES` - полный доступ к базе данных
- `CREATEDB` - возможность создавать новые базы данных

#### Шаг 5: Выход из PostgreSQL
```sql
\q
```

#### Шаг 6: Проверка создания
```bash
sudo -u postgres psql -l | grep gardenfab
```

**Ожидаемый результат:**
```
 gardenfab | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
```

---

## 🚀 2.7 Запуск скрипта развертывания

### Что происходит:
Запускаем автоматический скрипт, который выполнит все необходимые действия по развертыванию.

### Пошаговые действия:

#### Шаг 1: Запуск в production режиме
```bash
./deploy.sh production
```

**Объяснение режимов:**
- `production` - продакшн окружение (оптимизировано для работы)
- `staging` - тестовое окружение (для проверки перед продакшном)

#### Шаг 2: Мониторинг процесса
```bash
# В отдельном терминале следим за логами
pm2 logs gardenfab
```

**Что происходит во время выполнения:**

1. **Создание резервной копии**
   - База данных: `pg_dump gardenfab > backup.sql`
   - Файлы приложения: `tar -czf app_backup.tar.gz`

2. **Остановка приложения**
   - `pm2 stop gardenfab`

3. **Обновление кода**
   - `git fetch origin`
   - `git reset --hard origin/main`

4. **Установка зависимостей**
   - `npm ci --only=production`

5. **Генерация Prisma клиента**
   - `npx prisma generate`

6. **Применение миграций**
   - `npx prisma migrate deploy`

7. **Сборка приложения**
   - `npm run build`

8. **Запуск через PM2**
   - `pm2 start ecosystem.config.js`

9. **Проверка работоспособности**
   - Тест доступности на localhost:3000

10. **Перезагрузка Nginx**
    - `sudo systemctl reload nginx`

---

## 📊 2.8 Мониторинг процесса развертывания

### Что происходит:
Отслеживаем процесс развертывания в реальном времени для выявления возможных проблем.

### Пошаговые действия:

#### Шаг 1: Открытие нового терминала
```bash
# Подключаемся к серверу в новом терминале
ssh user@ваш_сервер_ip
```

#### Шаг 2: Мониторинг логов PM2
```bash
pm2 logs gardenfab
```

**Что показывают логи:**
- Процесс запуска приложения
- Ошибки и предупреждения
- Информация о подключении к базе данных

#### Шаг 3: Мониторинг всех процессов
```bash
pm2 monit
```

**Интерфейс мониторинга показывает:**
- CPU и память для каждого процесса
- Статус процессов (online/offline)
- Количество перезапусков

#### Шаг 4: Проверка статуса
```bash
pm2 status
```

**Ожидаемый результат:**
```
┌─────────────┬────┬─────────┬─────────┬─────────┬──────┬────────┬──────┐
│ App name    │ id │ version │ mode    │ pid     │ uptime │ ↺    │ status │
├─────────────┼────┼─────────┼─────────┼─────────┼──────┼────────┼──────┤
│ gardenfab   │ 0  │ 0.1.0   │ cluster │ 12345   │ 2m     │ 0    │ online │
└─────────────┴────┴─────────┴─────────┴─────────┴──────┴────────┴──────┘
```

---

## ✅ 2.9 Проверка результатов

### Что происходит:
Проверяем, что все компоненты системы работают корректно после развертывания.

### Пошаговые действия:

#### Шаг 1: Проверка доступности приложения
```bash
curl -I http://localhost:3000
```

**Ожидаемый результат:**
```
HTTP/1.1 200 OK
Content-Type: text/html; charset=utf-8
```

#### Шаг 2: Проверка статуса PM2
```bash
pm2 list
```

**Проверяем:**
- Статус: `online`
- Uptime: больше 0
- Количество перезапусков: минимальное

#### Шаг 3: Проверка логов
```bash
pm2 logs gardenfab --lines 20
```

**Ищем в логах:**
- Отсутствие ошибок
- Успешное подключение к базе данных
- Сообщения о запуске сервера

#### Шаг 4: Проверка сервисов
```bash
sudo systemctl status nginx
sudo systemctl status postgresql
```

**Ожидаемый результат:**
```
● nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: active (running) since ...
```

---

## 🆘 2.10 Устранение возможных проблем

### Что происходит:
Решаем типичные проблемы, которые могут возникнуть во время развертывания.

### Пошаговые действия:

#### Проблема 1: Скрипт не запускается

**Диагностика:**
```bash
bash -n deploy.sh
```

**Запуск с подробным выводом:**
```bash
bash -x deploy.sh production
```

**Возможные причины:**
- Неправильные права доступа
- Синтаксические ошибки в скрипте
- Отсутствие bash интерпретатора

#### Проблема 2: Приложение не запускается

**Проверка логов:**
```bash
pm2 logs gardenfab
```

**Перезапуск:**
```bash
pm2 restart gardenfab
```

**Проверка переменных окружения:**
```bash
pm2 env gardenfab
```

**Возможные причины:**
- Ошибки в коде приложения
- Неправильные переменные окружения
- Проблемы с базой данных

#### Проблема 3: База данных недоступна

**Проверка статуса:**
```bash
sudo systemctl status postgresql
```

**Перезапуск сервиса:**
```bash
sudo systemctl restart postgresql
```

**Проверка подключения:**
```bash
sudo -u postgres psql -d gardenfab -c "SELECT 1;"
```

**Возможные причины:**
- Сервис PostgreSQL не запущен
- Неправильные права доступа
- Проблемы с конфигурацией

---

## 🎯 Ключевые моменты для успешного выполнения

### ✅ Обязательные проверки:
1. **Права доступа** - скрипт должен быть исполняемым
2. **Зависимости** - все необходимые пакеты установлены
3. **База данных** - PostgreSQL запущен и доступен
4. **Директории** - созданы с правильными правами
5. **Пользователь** - gardenfab пользователь существует

### ⚠️ Частые ошибки:
1. **Забыли сделать скрипт исполняемым** (`chmod +x`)
2. **Не создали базу данных** перед запуском
3. **Неправильные права доступа** к директориям
4. **Отсутствие необходимых пакетов** (Node.js, npm, git)

### 🔍 Признаки успешного выполнения:
1. **PM2 статус** показывает `online`
2. **Приложение отвечает** на localhost:3000
3. **Логи без критических ошибок**
4. **Все сервисы активны** (nginx, postgresql)

---

## 📚 Дополнительные ресурсы

- **Полная инструкция:** [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md)
- **Быстрое развертывание:** [QUICK_DEPLOY.md](QUICK_DEPLOY.md)
- **Конфигурация PM2:** [ecosystem.config.js](ecosystem.config.js)
- **Конфигурация Nginx:** [nginx-gardenfab.conf](nginx-gardenfab.conf)
